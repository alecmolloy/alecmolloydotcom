<!DOCTYPE html>
<!-- saved from url=(0049)https://auduno.github.io/clmtrackr/clm_image.html -->
<html lang="en">
<script type="text/javascript" async="" src="./image_files/ga.js"></script>

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<title>Face Tracker</title>

</head>

<body>
	<script src="./image_files/numeric-1.2.6.min.js"></script>
	<script src="./image_files/mosse.js"></script>
	<script src="./image_files/jsfeat-min.js"></script>
	<script src="./image_files/frontalface.js"></script>
	<script src="./image_files/jsfeat_detect.js"></script>
	<script src="./image_files/left_eye_filter.js"></script>
	<script src="./image_files/right_eye_filter.js"></script>
	<script src="./image_files/nose_filter.js"></script>
	<script src="./image_files/model_pca_20_svm.js"></script>
	<script src="./image_files/clm.js"></script>
	<script src="./image_files/svmfilter_webgl.js"></script>
	<script src="./image_files/svmfilter_fft.js"></script>
	<script src="./image_files/mossefilter.js"></script>
	<script src="./image_files/Stats.js"></script>

	<link rel="stylesheet" type="text/css" href="./image_files/imgareaselect-default.css">
	<script src="./image_files/jquery.min.js"></script>
	<script src="./image_files/jquery.imgareaselect.pack.js"></script>
	<script src="./image_files/BlobBuilder.min.js"></script>
	<script src="./image_files/Filesaver.min.js"></script>

	<div id="content">
		<h2>Face tracking in images</h2>
		<div id="container">
			<canvas id="image" width="625" height="500"></canvas>
			<canvas id="overlay" width="625" height="500"></canvas>
		</div>
		<input type="button" class="btn" value="start" onclick="animateClean()">
		<input type="button" class="btn" value="manually select face" onclick="selectBox()">
		<input type="file" class="btn" id="files" name="files[]">
		<p id="convergence"></p>
		<div id="text">
			<p>This is an example of precise face-tracking in an image using the javascript library <a href="https://github.com/auduno/clmtrackr"><em>clmtrackr</em></a>. To try it out, simply click start.</p>
			<span id="loadimagetext"><p>To try it out with your own image, choose a file above by clicking "choose file". If the tracking has problems, try selecting the face in the image manually by clicking "manually select face", and click and hold to drag a square around the face in the image.</p></span>
		</div>
		<p>The image is from the <a href="http://www-prima.inrialpes.fr/FGnet/data/01-TalkingFace/talking_face.html%E2%80%8E">FG-net Talking Face</a> project</p>
		<a href="https://github.com/auduno/clmtrackr"><img style="position: absolute; top: 0; left: 0; border: 0;" src="./image_files/forkme_left_green_007200.png" alt="Fork me on GitHub"></a>

		<script>
			var cc = document.getElementById('image').getContext('2d');
			var overlay = document.getElementById('overlay');
			var overlayCC = overlay.getContext('2d');

			var img = new Image();
			img.onload = function () {
				cc.drawImage(img, 0, 0, 625, 500);
			};
			img.src = './media/franck_02159.jpg';

			var ctrack = new clm.tracker({
				stopOnConvergence: true
			});
			ctrack.init(pModel);

			stats = new Stats();
			stats.domElement.style.position = 'absolute';
			stats.domElement.style.top = '0px';
			document.getElementById('container').appendChild(stats.domElement);

			var drawRequest;

			function animateClean() {
				ctrack.start(document.getElementById('image'));
				drawLoop();
			}

			function animate(box) {
				ctrack.start(document.getElementById('image'), box);
				drawLoop();
			}

			function drawLoop() {
				drawRequest = requestAnimFrame(drawLoop);
				overlayCC.clearRect(0, 0, 720, 576);
				if (ctrack.getCurrentPosition()) {
					ctrack.draw(overlay);
				}
			}

			// detect if tracker fails to find a face
			document.addEventListener("clmtrackrNotFound", function (event) {
				ctrack.stop();
				alert("The tracking had problems with finding a face in this image. Try selecting the face in the image manually.")
			}, false);

			// detect if tracker loses tracking of face
			document.addEventListener("clmtrackrLost", function (event) {
				ctrack.stop();
				alert("The tracking had problems converging on a face in this image. Try selecting the face in the image manually.")
			}, false);

			// detect if tracker has converged
			document.addEventListener("clmtrackrConverged", function (event) {
				document.getElementById('convergence').innerHTML = "CONVERGED";
				document.getElementById('convergence').style.backgroundColor = "#00FF00";
				// stop drawloop
				cancelRequestAnimFrame(drawRequest);
			}, false);

			// update stats on iteration
			document.addEventListener("clmtrackrIteration", function (event) {
				stats.update();
			}, false);


			// function to start showing images
			function loadImage() {
				if (fileList.indexOf(fileIndex) < 0) {
					var reader = new FileReader();
					reader.onload = (function (theFile) {
						return function (e) {
							// check if positions already exist in storage

							// Render thumbnail.
							var canvas = document.getElementById('image')
							var cc = canvas.getContext('2d');
							var img = new Image();
							img.onload = function () {
								if (img.height > 500 || img.width > 700) {
									var rel = img.height / img.width;
									var neww = 700;
									var newh = neww * rel;
									if (newh > 500) {
										newh = 500;
										neww = newh / rel;
									}
									canvas.setAttribute('width', neww);
									canvas.setAttribute('height', newh);
									cc.drawImage(img, 0, 0, neww, newh);
								} else {
									canvas.setAttribute('width', img.width);
									canvas.setAttribute('height', img.height);
									cc.drawImage(img, 0, 0, img.width, img.height);
								}
							}
							img.src = e.target.result;
						};
					})(fileList[fileIndex]);
					reader.readAsDataURL(fileList[fileIndex]);
					overlayCC.clearRect(0, 0, 720, 576);
					document.getElementById('convergence').innerHTML = "";
					ctrack.reset();
				}

			}

			// set up file selector and variables to hold selections
			var fileList, fileIndex;
			if (window.File && window.FileReader && window.FileList) {
				function handleFileSelect(evt) {
					var files = evt.target.files;
					fileList = [];
					for (var i = 0; i < files.length; i++) {
						if (!files[i].type.match('image.*')) {
							continue;
						}
						fileList.push(files[i]);
					}
					if (files.length > 0) {
						fileIndex = 0;
					}

					loadImage();
				}
				document.getElementById('files').addEventListener('change', handleFileSelect, false);
			} else {
				$('#files').addClass("hide");
				$('#loadimagetext').addClass("hide");
			}
		</script>
	</div>
	<canvas width="11px" height="781px" id="renderCanvas" style="display:none;"></canvas>


</body>

</html>
